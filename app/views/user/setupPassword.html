<html>
	<head>
		<meta http-equiv="Content-Language" content="zh-cn">
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Insert title here</title>
		<style type="text/css">
			.passwrodBox {
				max-width: 500px;
				margin: 0 auto;
				padding: 100px 20px 20px 20px;
			}
			.pswdArea {
				background-color: #ffffff;
				color: inherit;
				padding: 15px 20px 20px 20px;
				border-color: #e7eaec;
				border-image: none;
				border-style: solid solid none;
				border-width: 1px 0;
				clear: both;
			}
			.areaMessage .msgTitle {
				margin-top: 5px;
				font-weight: 600;
				font-size: 24px;
				margin-bottom: 10px;
				line-height: 1.1;
				box-sizing: border-box;
				opacity: 0.65;
			}
			.areaMessage .msgNotice {
				font-size: 13px;
				opacity: 0.55;
			}
			.areaEditer {
				position: relative;
				margin-top: 25px;
				margin-bottom: 0px;
			}
			.areaEditer .form-control {
				background-color: #FFFFFF;
				background-image: none;
				border: 1px solid #e5e6e7;
				border-radius: 1px;
				color: inherit;
				display: block;
				padding: 6px 12px;
				transition: border-color 0.15s ease-in-out 0s, box-shadow 0.15s ease-in-out 0s;
				width: 100%;
				font-size: 14px;
				height: 34px;
				line-height: 1.42857143;
				margin-bottom: 15px;
			}
			.areaEditer .btn-primary {
				width: 100% !important;
				background-color: #1ab394;
				border-color: #1ab394;
				color: #FFFFFF;
				margin-bottom: 15px;
				display: block !important;
			}
			.areaEditer .btn {
				display: inline-block;
				padding: 6px 12px;
				margin-bottom: 0;
				font-size: 14px;
				font-weight: 400;
				line-height: 1.42857143;
				text-align: center;
				white-space: nowrap;
				vertical-align: middle;
				-ms-touch-action: manipulation;
				touch-action: manipulation;
				cursor: pointer;
				-webkit-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;
				background-image: none;
				border: 1px solid transparent;
				border-radius: 3px;
			}
			.copyRight {
				font-family: OpenSans;
				font-size: 12px;
				color: #6C6C6C;
				letter-spacing: 0;
				line-height: 22px;
				text-align: center;
			}
			.copyRight p {
				margin-top: 30px;
			}

			.invalidBox {
				padding: 100px 20px 20px 20px;
				background-color: #ffffff;
				color: inherit;
				border-color: #e7eaec;
				border-style: solid solid none;
				border-width: 1px;
				border: 1px solid #e5e6e7;
				border-radius: 1px;
				text-align: center;
			}
			.invalidBox p {
				font-weight: 600;
				font-size: 24px;
				opacity: 0.55;
				text-align: center;
			}
			.invalidBox .btn {
				display: inline-block;
				overflow: visible;
				padding: 0 22px;
				height: 30px;
				line-height: 30px;
				vertical-align: middle;
				text-align: center;
				text-decoration: none;
				border-radius: 3px;
				-moz-border-radius: 3px;
				-webkit-border-radius: 3px;
				font-size: 14px;
				border-width: 1px;
				border-style: solid;
				cursor: pointer;
				min-width: 60px;
			}
			.invalidBox .btn_return {
				width: 80px;
				height: 30px;
				background-color: #fff;
				background-image: linear-gradient(to bottom,#fff 0,#fff 100%);
				border-color: #e7e7eb;
				color: #222;
			}
		</style>
	</head>
	
	<body style="background-color: #f3f3f4;" onload="load()">
		<div class="passwrodBox" id="passwrodBox">
			<div class="pswdArea" id="pswdArea">
				<div class="areaMessage">
					<p class="msgTitle">Setup Password</p>
					<p class="msgNotice">Please setup your password at here, and then can login.</p>
				</div>
				<form class="areaEditer" role="form">
					<div class="form-group">
						<input type="password" class="form-control" id="passwordOrigin" placeholder="Password" onblur="checkPassword(this, 'origin')">
					</div>
					<div class="form-group">
						<input type="password" class="form-control" id="passwordRepeat" placeholder="Replace Password" onblur="checkPassword(this, 'repeat')">
					</div>
					<button type="button" class="btn btn-primary block full-width m-b" onclick="setup()">Setup password</button>

				</form>
			</div>

			<div class="trueBox" id="trueBox">
				

			</div>

			<div class="invalidBox" id="invalidBox">
				<div class="errMsg">
					<p>The link was invalid.</p>
				</div>

				<br><br><hr>
				
				<div class="errBtn">
					<a href="/" class="btn btn_return">Return</a>
				</div>

			</div>

			<div class="copyRight">
				<p>Copyright Â© 2015-2016 REVA(TM). All rights reserved.</p>
			</div>


		</div>




	</body>

	<script type="text/javascript">

		load = function() {
			// document.getElementById('invalidArea').hide();
			document.getElementById("invalidBox").style.display="none";
		};

		checkPassword = function(ele, model) {
			if (ele.value.trim() != '' && ele.value.length != 0) {
				var inputId;
				if (model == "origin") {
					inputId = "passwordOrigin";
				} else if (model == "repeat") {
					inputId = "passwordRepeat";
				}

				document.getElementById(inputId).style.backgroundColor = "#FFFFFF";
			}
		};

		setup = function() {
			var passwordOrigin = document.getElementById("passwordOrigin").value;
			var passwordRepeat = document.getElementById("passwordRepeat").value;

			if (passwordOrigin == "") {
				document.getElementById("passwordOrigin").focus();
				document.getElementById('passwordOrigin').style.backgroundColor = "#e74c3c";
				return false;
			}

			if (passwordRepeat == "") {
				document.getElementById("passwordRepeat").focus();
				document.getElementById('passwordRepeat').style.backgroundColor = "#e74c3c";
				return false;
			}

			if (passwordOrigin != passwordRepeat) {
				alert("The new password is not consistent with the repeat password.");
				document.getElementById('passwordRepeat').style.backgroundColor = "#e74c3c";
				return false;
			} else {
				document.getElementById('passwordOrigin').style.backgroundColor = "#FFFFFF";
				document.getElementById('passwordRepeat').style.backgroundColor = "#FFFFFF";
			}

			var url = window.location.href;
			url = "http://dev.revanow.com/statics/#/setupPassword?id=2ba29feed66ad9ba&password=ccba6db7e2bcb4b10768b84a6b8daf7456397dc33930dd8670aca661bb9d86e5acbd5c8f1f5d5364fee2e16ccef686da629206689a816e6a0962ac8e4513968d&timestamp=1487557605648";

			var s = url.indexOf("?"); 
			var postData = {
				userId: getQueryString(url, "id"),
				oldPassword : getQueryString(url, "password"),
				newPassword : passwordOrigin,
				timestamp : getQueryString(url, "timestamp")
			}

			// var userId = getQueryString(url, "id");
			// var password = getQueryString(url, "password");
			// var timestamp = getQueryString(url, "timestamp");
			var timeCharge = (new Date().getTime() - postData.timestamp) / (1000 * 60 * 60)

			if (timeCharge > 240) {
				document.getElementById("pswdArea").style.display = "none";
				document.getElementById("invalidBox").style.display = "";
				return false;
			}

			var url = '/admin/user/setupPassword';
            $.ajax({
                url : url,
                type : "POST",
                data : postData,
                success : function(result) {
                    if(result.status == 0 && result.code == 0){
                        $.ajax({
                            type: "post",
                            url: "/auth/main/logout"
                        }).success(function(result) {
                            location.href = "/";
                        }).error(function(result) {});
                    }else{
                    	alert("/admin/user/setupPassword err");
                        // $("#warn-message").text(result.msg);
                        // $("#warn-message").show();
                    }
                }

            });

			// var xhr = new XMLHttpRequest();

			// if (window.XMLHttpRequest) {
			// 	var xhr = new XMLHttpRequest();
			// } else {
			// 	var xhr = new ActiveXObject('Microsoft.XMLHTTP');
			// }

			// var url = '/admin/user/setupPassword';
			// xhr.open('POST', url, true);
			// xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
			// xhr.onreadystatechange = function() {
			// 	if (xhr.readyState == 4) {
			// 		var status = xhr.status;
			// 		if (status >= 200 && status < 300) {
			// 			// TODO auto login
			// 			alert("to do login");
			// 		} else {
			// 			alert("failed");
			// 		}
			// 	}
			// }

			// xhr.send(getPostParam(postData));
		}


		getQueryString = function(url, name) {
			var reg = new RegExp("(^|)" + name + "=([^&]*)(&|$)", "i"); 
			var res = url.substr(1).match(reg); 
			if (res != null) return unescape(res[2]); return null; 
		}

		getPostParam = function(objData) {
			var params = "";
			for(var prop in objData) {
				params += prop + "=" + objData[prop] + "&";
			}

			return params.substr(0, params.length - 1);
		}
	</script>
</html>